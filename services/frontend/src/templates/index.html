<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>English Text Checker</title>

    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
            rel="stylesheet"
    >

    <link rel="stylesheet" href="/static/style.css">
</head>
<body class="bg-light">
<div class="container py-5">
    <h1 class="mb-4">English Text Checker</h1>

    <form id="check-form" class="mb-4">
        <div class="mb-3">
            <label for="text" class="form-label">Enter your text:</label>
            <textarea
                    id="text"
                    name="text"
                    class="form-control"
                    rows="5"
                    placeholder="Type your English text here..."
            >{{ text }}</textarea>
        </div>
        <button type="submit" class="btn btn-primary">Check</button>
    </form>

    <div id="loader" class="d-none">
        <div class="spinner-border spinner-border-sm"></div>
        <span class="ms-2">Analyzing...</span>
    </div>

    <div id="result-block" class="mt-4 d-none">
        <div class="card mb-3">
            <div class="card-header">
                Corrected version
            </div>
            <div class="card-body">
                <p id="corrected-text" class="card-text"></p>
            </div>
        </div>

        <div class="card mb-3">
            <div class="card-header">
                Explanation
            </div>
            <div class="card-body">
                <p id="explanation-text" class="card-text"></p>
            </div>
        </div>

        <div class="card mb-3 d-none" id="errors-card">
            <div class="card-header">
                Errors
            </div>
            <div class="card-body">
                <ul id="errors-list" class="mb-0"></ul>
            </div>
        </div>
    </div>
</div>

<script>
    const form = document.getElementById("check-form");
    const loader = document.getElementById("loader");
    const resultBlock = document.getElementById("result-block");
    const correctedTextEl = document.getElementById("corrected-text");
    const explanationTextEl = document.getElementById("explanation-text");
    const errorsCard = document.getElementById("errors-card");
    const errorsList = document.getElementById("errors-list");

    form.addEventListener("submit", async (event) => {
        event.preventDefault();

        const textarea = document.getElementById("text");
        const text = textarea.value.trim();

        if (!text) {
            alert("Введите текст");
            return;
        }

        loader.classList.remove("d-none");
        resultBlock.classList.add("d-none");
        errorsCard.classList.add("d-none");
        errorsList.innerHTML = "";

        try {
            const response = await fetch("/api/check", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    user_id: 1,     // пока заглушка
                    text: text,
                    level: "B1"     // тоже заглушка
                })
            });

            if (!response.ok) {
                throw new Error("Server error: " + response.status);
            }

            const data = await response.json();

            correctedTextEl.textContent = data.corrected_text;
            explanationTextEl.textContent = data.explanation;

            if (data.errors && data.errors.length > 0) {
                data.errors.forEach(err => {
                    const li = document.createElement("li");
                    li.textContent = JSON.stringify(err);
                    errorsList.appendChild(li);
                });
                errorsCard.classList.remove("d-none");
            }

            resultBlock.classList.remove("d-none");
        } catch (e) {
            alert("Ошибка при обращении к /api/check: " + e.message);
        } finally {
            loader.classList.add("d-none");
        }
    });
</script>
</body>
</html>
